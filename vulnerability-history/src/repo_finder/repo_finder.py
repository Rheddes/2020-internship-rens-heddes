import logging

from mysql.connector import connect

from utils.core import Status
from utils.libraries_api import find_repos_with_fixed_versions_for
from utils.runner import Runner


class RepoFinder(Runner):
    def _add_repos_to_db(self, repos, cve):
        repos = [{**repo, 'cve': cve}for repo in repos]
        with self._connection.cursor() as cursor:
            cursor.executemany(
                'INSERT INTO repos (full_name, pom_path, cve) VALUES (%(full_name)s, %(pom_path)s, %(cve)s)',
                repos
            )
            cursor.execute(f"UPDATE vulnerabilities SET status='{Status.DONE}' WHERE cve=%s", [cve])
        self._connection.commit()

    def run_once(self):
        with self._connection.cursor() as cursor:
            cursor.execute(f"""
                SELECT v.cve, package_coords, libraries_io_find_prefix, samples, COUNT(r.cve) as current_samples
                FROM vulnerabilities as v
                LEFT JOIN repos r ON r.cve = v.cve
                WHERE v.status = '{Status.NEW}' OR v.status = '{Status.CHANGED}'
                GROUP BY r.cve
            """)
            for (cve, package_coords, search_prefix, wanted_samples, current_samples) in cursor:
                self._logger.info('Finding {} new repos for {}'.format(max(0, wanted_samples-current_samples), cve))
                repos = find_repos_with_fixed_versions_for(package_coords, search_prefix, wanted_samples-current_samples)
                self._add_repos_to_db(repos, cve)
            self._logger.info('No more vulnerabilities to find repos for')


if __name__ == '__main__':
    logging.getLogger(__name__).setLevel(logging.INFO)
    with connect(host='127.0.0.1', port=33061, user='vulnerability-history', database='vulnerability-history',
                 password='secret') as conn:
        repo_finder = RepoFinder(conn, logging.getLogger(__name__))
        repo_finder.run_once()

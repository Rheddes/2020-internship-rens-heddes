import json
from requests import Request, Session
from requests_throttler import ThrottledRequest, BaseThrottler

from config import http_params_paginated, http_params


def find_dependency(response: ThrottledRequest, name):
    try:
        repo_info = response.response.json()
    except json.decoder.JSONDecodeError:
        print('error')
        return None, None
    if 'dependencies' not in repo_info:
        return None, None
    investigated_dep = [dep for dep in repo_info['dependencies'] if dep['project_name'] == name]
    if not len(investigated_dep) > 0 or not investigated_dep[0]['filepath'] == 'pom.xml':
        return None, None
    return investigated_dep[0], repo_info


def execute_http_request(request: Request):
    session = Session()
    response = None
    for i in range(10):
        response = session.send(request.prepare())
        if response.status_code == 200:
            return response
    print('something went wrong')
    print(response.status_code)
    print(response.text)
    return Exception


def find_repos_with_fixed_versions_for(package, fixed_version_prefix, n=10):
    repos_with_fixed_version = []
    page = 1
    while len(repos_with_fixed_version) < n:
        r = execute_http_request(
            Request(method='GET', url='https://libraries.io/api/Maven/{}/dependent_repositories'.format(package),
                    params=http_params_paginated(page))
        )
        page += 1
        repositories = [repo for repo in r.json() if repo['host_type'] == 'GitHub']
        if len(repositories) == 0:
            return repos_with_fixed_version
        with BaseThrottler(name='base-throttler', delay=1.07) as bt:
            dependency_requests = [
                Request(method='GET', url='https://libraries.io/api/github/{}/dependencies'.format(repo['full_name']),
                        params=http_params) for repo in repositories]
            throttled_requests = bt.multi_submit(dependency_requests)

        for dependency_response in throttled_requests:
            dependency, repo_info = find_dependency(dependency_response, package)
            if dependency is None or dependency['requirements'] is None:
                continue
            if dependency['requirements'].startswith(fixed_version_prefix) and repo_info['fork'] is False:
                repos_with_fixed_version.append(
                    {'full_name': repo_info['full_name'], 'pom_path': dependency['filepath']})

    return repos_with_fixed_version

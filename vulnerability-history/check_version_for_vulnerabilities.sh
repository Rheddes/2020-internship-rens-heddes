#!/usr/bin/env bash

dependency_check_xml="${1}/dependency-check.xml"
maven_output="${1}/out/maven_output.$(git rev-parse --short HEAD).log"

mv pom.xml pom.original.xml
xmlstarlet ed -N my=http://maven.apache.org/POM/4.0.0  -s "//my:project/my:build/my:plugins" -t elem -n plugin -v "$(xmlstarlet sel -t -c '//plugin/*' $dependency_check_xml)" pom.original.xml | xmlstarlet unesc > pom.xml
mvn dependency:resolve dependency-check:check > $maven_output
if [ $? -eq 0 ]
then
  mv pom.original.xml pom.xml
  echo "No vulnerable dependencies found"
  exit 0
else
  mv pom.original.xml pom.xml
  echo "Vulnerability found in a dependency"
  exit 1
fi
